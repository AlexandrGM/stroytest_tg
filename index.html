<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    html, body { 
      font-family: 'Inter', sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      height: 100%; 
      width: 100%; 
      overflow: hidden; 
      position: fixed; 
      /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω iPhone */
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    main { 
      height: calc(100vh - 90px); /* –ß—É—Ç—å —É–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø –¥–ª—è —à–∞–ø–∫–∏ */
      overflow-y: auto; 
      -webkit-overflow-scrolling: touch; 
      padding-bottom: 40px; 
    }

    input { caret-color: #0039A6; }
    
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞–∂–∞—Ç–∏—è */
    .ans-card { transition: transform 0.1s, background-color 0.2s; }
    .ans-card:active { transform: scale(0.96); background-color: #F0F4F9; border-color: #0039A6; }
    
    .bg-v-blue { background-color: #0039A6; }
    .text-v-blue { color: #0039A6; }
    
    /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å —Ç–∞–π–º–µ—Ä–∞ */
    .timer-bar { transition: width 0.3s linear; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
  
  <script>const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzffvbKhxSaefP5_dwRjh3O0M7dG40EzXU9Tcys-W21VIWxJw5reNgX9BU1yM5GTThN6w/exec";</script>

  <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-[2rem] shadow-2xl p-8 border border-slate-100">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-black text-v-blue tracking-tight uppercase">–°—Ç—Ä–æ–π–¢–µ—Å—Ç</h1>
        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-2">–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è 2026</p>
      </div>
      <div class="space-y-4">
        <input id="inp-name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-xl focus:border-v-blue outline-none text-base font-medium transition-colors">
        <input id="inp-code" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-xl focus:border-v-blue outline-none text-base font-medium transition-colors">
        <button id="btn-go" onclick="runApp()" class="w-full bg-v-blue text-white font-black py-4 rounded-xl shadow-lg uppercase text-sm tracking-widest active:bg-blue-800 transition-transform active:scale-95">–í–æ–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <div id="quiz-page" class="hidden min-h-screen flex flex-col bg-white">
    <div class="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b px-5 py-3 max-w-2xl mx-auto w-full shadow-sm">
      <div class="flex justify-between items-end mb-2">
        <span id="txt-step" class="text-[10px] font-black text-v-blue uppercase italic">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <div class="text-right">
          <span id="txt-timer" class="text-2xl font-black text-slate-700 leading-none">30</span>
          <span class="text-[9px] text-slate-400 block font-bold uppercase">—Å–µ–∫</span>
        </div>
      </div>
      <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
        <div id="bar-timer" class="timer-bar bg-v-blue h-full w-full"></div>
      </div>
    </div>
    <main class="p-5 max-w-2xl mx-auto w-full">
      <h2 id="txt-q" class="text-[20px] md:text-[22px] font-bold leading-tight mb-6 text-slate-800"></h2>
      <div id="grid-ans" class="space-y-3"></div>
    </main>
  </div>

  <script>
    const tg = window.Telegram.WebApp; 
    tg.expand(); 
    tg.ready();

    // –î–æ–±–∞–≤–∏–ª–∏ –ø–æ–ª–µ focusLoss –¥–ª—è —É—á–µ—Ç–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    let state = { 
      qs: [], 
      cur: 0, 
      score: 0, 
      timerInterval: null, 
      endTime: 0, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
      user: "", 
      start: null, 
      errors: [],
      focusLoss: 0 
    };

    // –ê–ù–¢–ò-–ß–ò–¢: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    document.addEventListener("visibilitychange", () => {
      if (document.hidden && state.start && document.getElementById('quiz-page').style.display !== 'none') {
        state.focusLoss++;
        console.log("–£—Ö–æ–¥ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ", state.focusLoss);
      }
    });

    function runApp() {
      const n = document.getElementById('inp-name').value.trim();
      const c = document.getElementById('inp-code').value.trim();
      
      if(!n || !c) {
        tg.HapticFeedback.notificationOccurred('error'); // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
      }
      
      const btn = document.getElementById('btn-go');
      setLoading(true, btn);

      fetch(`${SCRIPT_URL}?action=init&name=${encodeURIComponent(n)}&code=${encodeURIComponent(c)}`)
        .then(r => r.json())
        .then(res => {
          if(res.error) { 
            alert(res.error); 
            setLoading(false, btn);
            return; 
          }
          state.qs = res.questions; 
          state.user = res.userName; 
          state.start = new Date();
          
          document.getElementById('login-page').classList.add('hidden');
          document.getElementById('quiz-page').classList.remove('hidden');
          render();
        })
        .catch(() => {
          alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
          setLoading(false, btn);
        });
    }

    function setLoading(isLoading, btn) {
      if(isLoading) {
        btn.innerText = "–ü–†–û–í–ï–†–ö–ê...";
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        btn.innerText = "–í–û–ô–¢–ò";
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    function render() {
      const q = state.qs[state.cur];
      document.getElementById('txt-step').innerText = `–í–æ–ø—Ä–æ—Å ${state.cur + 1} –∏–∑ ${state.qs.length}`;
      document.getElementById('txt-q').innerText = q[0];
      
      const grid = document.getElementById('grid-ans'); 
      grid.innerHTML = '';
      
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
      [1,2,3,4,5].forEach(i => {
        const txt = q[i] ? q[i].toString().trim() : "";
        if(txt) {
          const div = document.createElement('div');
          div.className = "ans-card p-4 border-2 border-slate-100 rounded-2xl cursor-pointer bg-slate-50 font-semibold text-slate-700 shadow-sm text-sm md:text-base select-none";
          div.innerText = txt; 
          div.onclick = () => {
            tg.HapticFeedback.impactOccurred('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ
            select(txt, q[6]);
          };
          grid.appendChild(div);
        }
      });
      
      startTimer(q[6]);
    }

    // –ù–û–í–´–ô –¢–ê–ô–ú–ï–†: –ù–∞ –æ—Å–Ω–æ–≤–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è)
    function startTimer(correct) {
      clearInterval(state.timerInterval);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è (—Å–µ–π—á–∞—Å + 30 —Å–µ–∫)
      state.endTime = Date.now() + 30000;
      
      updateTimerUI(30);

      state.timerInterval = setInterval(() => {
        const now = Date.now();
        const leftMs = state.endTime - now;
        const leftSec = Math.ceil(leftMs / 1000);

        if (leftSec <= 0) {
          clearInterval(state.timerInterval);
          updateTimerUI(0);
          select("–¢–∞–π–º–∞—É—Ç (–≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ)", correct);
        } else {
          updateTimerUI(leftSec);
        }
      }, 200); // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—â–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏, –Ω–æ –ª–æ–≥–∏–∫–∞ –Ω–∞ –≤—Ä–µ–º–µ–Ω–∏
    }

    function updateTimerUI(seconds) {
      document.getElementById('txt-timer').innerText = seconds;
      const pct = (seconds / 30) * 100;
      const bar = document.getElementById('bar-timer');
      bar.style.width = pct + '%';
      
      // –°–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
      if (seconds <= 5) {
        bar.className = "timer-bar bg-red-500 h-full w-full";
        if(seconds > 0 && seconds % 2 !== 0) tg.HapticFeedback.selectionChanged(); // –¢–∏–∫–∞–Ω—å–µ –≤–∏–±—Ä–∞—Ü–∏–µ–π
      } else {
        bar.className = "timer-bar bg-v-blue h-full w-full";
      }
    }

    function select(val, correct) {
      clearInterval(state.timerInterval);
      
      if(val.toString().trim() !== correct.toString().trim()) {
        state.errors.push({ q: state.qs[state.cur][0], user: val, right: correct });
        tg.HapticFeedback.notificationOccurred('warning');
      } else {
        state.score++;
      }
      
      state.cur++;
      if(state.cur < state.qs.length) {
        render();
      } else {
        finish();
      }
    }

    function finish() {
      const diffMs = new Date() - state.start;
      const diffMin = Math.floor(diffMs / 60000);
      const diffSec = Math.floor((diffMs % 60000) / 1000);
      const timeStr = `${diffMin} –º–∏–Ω. ${diffSec} —Å–µ–∫.`;
      
      // UI –ó–∞–≥—Ä—É–∑–∫–∏
      document.getElementById('quiz-page').innerHTML = `
        <div class="flex flex-col h-screen items-center justify-center p-10 text-center bg-white animate-fade-in">
          <div class="text-7xl mb-8 animate-bounce">üöÄ</div>
          <div class="text-xl font-black text-slate-800 uppercase tracking-tight">–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
          <div class="text-slate-400 text-sm mt-2">–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...</div>
        </div>`;

      // –î–æ–±–∞–≤–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (state.focusLoss)
      // –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–∞–∫ Plain Text –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
      const payload = JSON.stringify({ 
        userName: state.user, 
        score: state.score, 
        total: state.qs.length, 
        timeSpent: timeStr, 
        errors: state.errors,
        focusLoss: state.focusLoss // –ü–µ—Ä–µ–¥–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      });

      fetch(SCRIPT_URL, { 
        method: 'POST', 
        mode: 'no-cors', 
        headers: { 'Content-Type': 'text/plain' }, 
        body: payload 
      })
      .then(() => {
        tg.HapticFeedback.notificationOccurred('success');
        
        // UI –†–µ–∑—É–ª—å—Ç–∞—Ç–∞
        document.getElementById('quiz-page').innerHTML = `
          <div class="flex flex-col h-screen items-center justify-center p-6 text-center bg-white">
            <div class="text-6xl mb-6">üéØ</div>
            <h2 class="text-3xl font-black text-v-blue mb-2 italic tracking-tight">–ì–û–¢–û–í–û</h2>
            <p class="text-slate-500 mb-8 text-sm font-medium italic">
              –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.<br>
              ${state.focusLoss > 0 ? `<span class="text-red-500 text-xs mt-2 block">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–π: ${state.focusLoss}</span>` : ''}
            </p>
            <div class="w-full max-w-xs bg-slate-900 text-white p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden mx-auto transform transition hover:scale-105">
               <div class="absolute top-0 right-0 p-4 opacity-10 text-7xl italic">üèÜ</div>
               <div class="relative z-10 text-5xl font-black mb-4">${state.score} / ${state.qs.length}</div>
               <div class="relative z-10 text-slate-400 font-bold uppercase text-[9px]">–í—Ä–µ–º—è: ${timeStr}</div>
            </div>
            <button onclick="tg.close()" class="mt-12 text-slate-400 font-bold uppercase text-[10px] border-b border-slate-200 pb-1 tracking-widest hover:text-slate-600">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>`;
      })
      .catch(e => alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏, –Ω–æ —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç."));
    }
  </script>
</body>
</html>
